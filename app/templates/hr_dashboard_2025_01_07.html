<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR ÎåÄÏãúÎ≥¥Îìú 2025ÎÖÑ 1Ïõî 7Ïùº Î≤ÑÏ†Ñ</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }
        
        .hr-dashboard {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
        }
        
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
            background: white;
            padding: 0 20px;
            border-radius: 8px 8px 0 0;
        }
        
        .tab-button {
            padding: 15px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
            font-weight: 600;
        }
        
        .tab-button:hover {
            color: #1890ff;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
            margin-bottom: 24px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .employee-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .employee-table th,
        .employee-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .employee-table th {
            background: #fafafa;
            font-weight: 600;
        }
        
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        
        .tag-green { background: #f6ffed; color: #52c41a; }
        .tag-blue { background: #e6f7ff; color: #1890ff; }
        .tag-orange { background: #fff7e6; color: #fa8c16; }
        .tag-red { background: #fff1f0; color: #ff4d4f; }
        .tag-purple { background: #f9f0ff; color: #722ed1; }
        
        .search-box {
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            width: 300px;
            font-size: 14px;
        }
        
        .error {
            background: #fff1f0;
            color: #ff4d4f;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info {
            background: #e6f7ff;
            color: #1890ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="hr-dashboard-root">
        <div class="loading">HR ÎåÄÏãúÎ≥¥Îìú Î°úÎî© Ï§ë...</div>
    </div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const { useState, useEffect, createElement: h } = React;
        
        function HRDashboard() {
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [employees, setEmployees] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedEmployee, setSelectedEmployee] = useState(null);
            const [error, setError] = useState(null);
            
            useEffect(() => {
                fetchData();
            }, []);
            
            const fetchData = async () => {
                try {
                    setLoading(true);
                    console.log('HR ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî©...');
                    
                    // HR ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ
                    let statsData = null;
                    const statsResponse = await fetch('/api/v1/hr-dashboard/stats');
                    if (statsResponse.ok) {
                        statsData = await statsResponse.json();
                        setData(statsData);
                    }
                    
                    // ÏßÅÏõê Î™©Î°ù - Ïó¨Îü¨ ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏãúÎèÑ
                    let employeeData = [];
                    
                    // 1Ï∞®: /api/v1/employees
                    try {
                        const empResponse = await fetch('/api/v1/employees');
                        if (empResponse.ok) {
                            const empData = await empResponse.json();
                            console.log('/api/v1/employees ÏùëÎãµ:', empData);
                            
                            // Îã§ÏñëÌïú ÏùëÎãµ Íµ¨Ï°∞ Ï≤òÎ¶¨
                            if (Array.isArray(empData)) {
                                employeeData = empData;
                            } else if (empData.results && Array.isArray(empData.results)) {
                                employeeData = empData.results;
                            } else if (empData.data && Array.isArray(empData.data)) {
                                employeeData = empData.data;
                            }
                        }
                    } catch (e) {
                        console.log('/api/v1/employees Ïã§Ìå®:', e);
                    }
                    
                    // 2Ï∞®: /api/v1/employees/ai-analysis/list
                    if (!Array.isArray(employeeData) || employeeData.length === 0) {
                        try {
                            const listResponse = await fetch('/api/v1/employees/ai-analysis/list');
                            if (listResponse.ok) {
                                const listData = await listResponse.json();
                                console.log('/api/v1/employees/ai-analysis/list ÏùëÎãµ:', listData);
                                
                                if (Array.isArray(listData)) {
                                    employeeData = listData;
                                } else if (listData.results && Array.isArray(listData.results)) {
                                    employeeData = listData.results;
                                } else if (listData.data && Array.isArray(listData.data)) {
                                    employeeData = listData.data;
                                }
                            }
                        } catch (e) {
                            console.log('/api/v1/employees/ai-analysis/list Ïã§Ìå®:', e);
                        }
                    }
                    
                    // 3Ï∞®: HR ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏßÅÏõê Ï†ïÎ≥¥ Ï∂îÏ∂ú
                    if (!Array.isArray(employeeData) || employeeData.length === 0) {
                        if (statsData) {
                            const allEmployees = [];
                            
                            // ÏäπÏßÑ ÌõÑÎ≥¥Ïûê
                            if (statsData.promotion_candidates?.candidates) {
                                allEmployees.push(...statsData.promotion_candidates.candidates);
                            }
                            
                            // Top Talent
                            if (statsData.top_talents?.employees) {
                                allEmployees.push(...statsData.top_talents.employees);
                            }
                            
                            // Í¥ÄÎ¶¨ ÌïÑÏöî Ïù∏Î†•
                            if (statsData.risk_employees?.employees) {
                                allEmployees.push(...statsData.risk_employees.employees);
                            }
                            
                            // Ï§ëÎ≥µ Ï†úÍ±∞
                            const uniqueEmployees = {};
                            allEmployees.forEach(emp => {
                                if (emp.uid && !uniqueEmployees[emp.uid]) {
                                    uniqueEmployees[emp.uid] = emp;
                                }
                            });
                            
                            employeeData = Object.values(uniqueEmployees);
                            console.log('HR ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï∂îÏ∂úÌïú ÏßÅÏõê:', employeeData.length);
                        }
                    }
                    
                    // Î∞∞Ïó¥ ÌôïÏù∏ ÌõÑ ÏÑ§Ï†ï
                    setEmployees(Array.isArray(employeeData) ? employeeData : []);
                    setError(null);
                } catch (err) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', err);
                    setError('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                } finally {
                    setLoading(false);
                }
            };
            
            const fetchEmployeeDetail = async (employeeId) => {
                try {
                    const response = await fetch(`/api/v1/employees/${employeeId}/ai-analysis`);
                    if (response.ok) {
                        const data = await response.json();
                        setSelectedEmployee({ id: employeeId, data });
                    }
                } catch (err) {
                    console.error('ÏßÅÏõê ÏÉÅÏÑ∏ Ï°∞Ìöå Ïã§Ìå®:', err);
                }
            };
            
            const downloadPdf = async () => {
                try {
                    const response = await fetch('/api/v1/hr-dashboard/export/pdf');
                    if (!response.ok) throw new Error('PDF Îã§Ïö¥Î°úÎìú Ïã§Ìå®');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `HR_Dashboard_${new Date().toISOString().slice(0, 10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (err) {
                    alert('PDF Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ' + err.message);
                }
            };
            
            // Í≤ΩÏòÅÏßÑ ÎåÄÏãúÎ≥¥Îìú Î†åÎçîÎßÅ
            const renderDashboard = () => {
                if (!data) return h('div', { className: 'loading' }, 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                
                return h('div', null,
                    // ÌÜµÍ≥Ñ Ïπ¥Îìú
                    h('div', { className: 'stats-grid' },
                        h('div', { className: 'stat-card' },
                            h('div', { className: 'stat-number' }, data.total_employees || 0),
                            h('div', { className: 'stat-label' }, 'Ï¥ù ÏßÅÏõê')
                        ),
                        h('div', { className: 'stat-card' },
                            h('div', { className: 'stat-number', style: { color: '#52c41a' } }, 
                                data.promotion_candidates?.count || 0),
                            h('div', { className: 'stat-label' }, 'ÏäπÏßÑ ÌõÑÎ≥¥Ïûê')
                        ),
                        h('div', { className: 'stat-card' },
                            h('div', { className: 'stat-number', style: { color: '#722ed1' } }, 
                                data.top_talents?.count || 0),
                            h('div', { className: 'stat-label' }, 'ÌïµÏã¨ Ïù∏Ïû¨')
                        ),
                        h('div', { className: 'stat-card' },
                            h('div', { className: 'stat-number', style: { color: '#ff4d4f' } }, 
                                data.risk_employees?.count || 0),
                            h('div', { className: 'stat-label' }, 'Í¥ÄÎ¶¨ ÌïÑÏöî')
                        )
                    ),
                    
                    // ÏäπÏßÑ ÌõÑÎ≥¥Ïûê
                    data.promotion_candidates?.candidates?.length > 0 && h('div', { className: 'section' },
                        h('h3', null, `ÏäπÏßÑ ÌõÑÎ≥¥Ïûê (${data.promotion_candidates.count}Î™Ö)`),
                        h('table', { className: 'employee-table' },
                            h('thead',
                                h('tr',
                                    h('th', null, 'Ïù¥Î¶Ñ'),
                                    h('th', null, 'Î∂ÄÏÑú'),
                                    h('th', null, 'ÏßÅÍ∏â'),
                                    h('th', null, 'Ï†êÏàò'),
                                    h('th', null, 'ÌåêÎã® ÏÇ¨Ïú†')
                                )
                            ),
                            h('tbody',
                                data.promotion_candidates.candidates.map(emp =>
                                    h('tr', { key: emp.uid },
                                        h('td', null, emp.name),
                                        h('td', null, emp.department),
                                        h('td', null, emp.position),
                                        h('td', null, emp.score),
                                        h('td', null,
                                            emp.reasons?.map(r => 
                                                h('span', { className: 'tag tag-blue', key: r }, r)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    
                    // Top Talent
                    data.top_talents?.employees?.length > 0 && h('div', { className: 'section' },
                        h('h3', null, `Top Talent (${data.top_talents.count}Î™Ö)`),
                        h('table', { className: 'employee-table' },
                            h('thead',
                                h('tr',
                                    h('th', null, 'ÏàúÏúÑ'),
                                    h('th', null, 'Ïù¥Î¶Ñ'),
                                    h('th', null, 'Î∂ÄÏÑú'),
                                    h('th', null, 'Îì±Í∏â'),
                                    h('th', null, 'Ï†êÏàò'),
                                    h('th', null, 'ÌåêÎã® ÏÇ¨Ïú†')
                                )
                            ),
                            h('tbody',
                                data.top_talents.employees.map((emp, idx) =>
                                    h('tr', { key: emp.uid },
                                        h('td', null, idx + 1),
                                        h('td', null, emp.name),
                                        h('td', null, emp.department),
                                        h('td', null,
                                            h('span', { className: `tag tag-${emp.grade === 'S' ? 'green' : 'blue'}` }, 
                                                emp.grade)
                                        ),
                                        h('td', null, emp.score),
                                        h('td', null,
                                            emp.reasons?.slice(0, 2).map(r => 
                                                h('span', { className: 'tag tag-purple', key: r }, r)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    
                    // Í¥ÄÎ¶¨ ÌïÑÏöî Ïù∏Î†•
                    data.risk_employees?.employees?.length > 0 && h('div', { className: 'section' },
                        h('h3', null, `Í¥ÄÎ¶¨ ÌïÑÏöî Ïù∏Î†• (${data.risk_employees.count}Î™Ö)`),
                        h('div', { style: { marginBottom: '10px' } },
                            h('span', { className: 'tag tag-red' }, 
                                `Í≥†ÏúÑÌóò ${data.risk_employees.high_risk_count}Î™Ö`),
                            h('span', { className: 'tag tag-orange' }, 
                                `Ï§ëÏúÑÌóò ${data.risk_employees.medium_risk_count}Î™Ö`)
                        ),
                        h('table', { className: 'employee-table' },
                            h('thead',
                                h('tr',
                                    h('th', null, 'Ïù¥Î¶Ñ'),
                                    h('th', null, 'Î∂ÄÏÑú'),
                                    h('th', null, 'ÏúÑÌóòÎèÑ'),
                                    h('th', null, 'Ï†êÏàò'),
                                    h('th', null, 'Í¥ÄÎ¶¨ ÏÇ¨Ïú†')
                                )
                            ),
                            h('tbody',
                                data.risk_employees.employees.slice(0, 10).map(emp =>
                                    h('tr', { key: emp.uid },
                                        h('td', null, emp.name),
                                        h('td', null, emp.department),
                                        h('td', null,
                                            h('span', { 
                                                className: `tag tag-${emp.risk_level === 'high' ? 'red' : 'orange'}` 
                                            }, emp.risk_level === 'high' ? 'ÎÜíÏùå' : 'Î≥¥ÌÜµ')
                                        ),
                                        h('td', null, emp.risk_score),
                                        h('td', null,
                                            emp.reasons?.map(r => 
                                                h('span', { 
                                                    className: `tag tag-${r.includes('Î∂ÄÏßÑ') ? 'red' : 'orange'}`, 
                                                    key: r 
                                                }, r)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
            };
            
            // Ï†ÑÏßÅÏõêÎ∂ÑÏÑù Î†åÎçîÎßÅ
            const renderEmployeeAnalysis = () => {
                // employeesÍ∞Ä Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
                const employeeList = Array.isArray(employees) ? employees : [];
                
                const filteredEmployees = employeeList.filter(emp => {
                    const query = searchQuery.toLowerCase();
                    return (emp.uid || '').toLowerCase().includes(query) ||
                           (emp.employee_name || '').toLowerCase().includes(query) ||
                           (emp.id || '').toLowerCase().includes(query);
                });
                
                if (selectedEmployee) {
                    const detail = selectedEmployee.data;
                    return h('div', { className: 'section' },
                        h('button', {
                            className: 'btn',
                            onClick: () => setSelectedEmployee(null)
                        }, '‚Üê Î™©Î°ùÏúºÎ°ú'),
                        h('h2', null, `${detail.employee_name || selectedEmployee.id} AI Î∂ÑÏÑù Î≥¥Í≥†ÏÑú`),
                        h('div', { className: 'stats-grid', style: { marginTop: '20px' } },
                            h('div', { className: 'stat-card' },
                                h('div', { className: 'stat-number' }, Math.round(detail.ai_score || 0)),
                                h('div', { className: 'stat-label' }, 'AI Ï¢ÖÌï©Ï†êÏàò')
                            ),
                            h('div', { className: 'stat-card' },
                                h('div', { className: 'stat-number' }, detail.grade || 'C'),
                                h('div', { className: 'stat-label' }, 'AI Îì±Í∏â')
                            )
                        ),
                        detail.strengths && h('div', null,
                            h('h3', null, 'Í∞ïÏ†ê'),
                            h('ul', null, detail.strengths.map(s => h('li', { key: s }, s)))
                        ),
                        detail.improvements && h('div', null,
                            h('h3', null, 'Í∞úÏÑ†Ï†ê'),
                            h('ul', null, detail.improvements.map(i => h('li', { key: i }, i)))
                        )
                    );
                }
                
                return h('div', { className: 'section' },
                    h('div', { style: { marginBottom: '20px' } },
                        h('input', {
                            type: 'text',
                            className: 'search-box',
                            placeholder: 'ÏßÅÏõê Í≤ÄÏÉâ (Ïù¥Î¶Ñ, ÏÇ¨Î≤à)',
                            value: searchQuery,
                            onChange: (e) => setSearchQuery(e.target.value)
                        }),
                        h('span', { style: { marginLeft: '20px', color: '#666' } }, 
                            `Ï¥ù ${employeeList.length}Î™ÖÏùò ÏßÅÏõê Îç∞Ïù¥ÌÑ∞`)
                    ),
                    employeeList.length === 0 ? 
                        h('div', { className: 'info' }, 'ÏßÅÏõê Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏù¥Í±∞ÎÇò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.') :
                    h('table', { className: 'employee-table' },
                        h('thead',
                            h('tr',
                                h('th', null, 'ÏÇ¨Î≤à'),
                                h('th', null, 'Ïù¥Î¶Ñ'),
                                h('th', null, 'Î∂ÄÏÑú'),
                                h('th', null, 'ÏßÅÍ∏â'),
                                h('th', null, 'AI Îì±Í∏â'),
                                h('th', null, 'AI Ï†êÏàò'),
                                h('th', null, 'ÏÉÅÏÑ∏')
                            )
                        ),
                        h('tbody',
                            filteredEmployees.slice(0, 50).map(emp =>
                                h('tr', { key: emp.id },
                                    h('td', null, emp.uid || emp.id?.slice(0, 8) || '-'),
                                    h('td', null, emp.employee_name || 'ÏùµÎ™Ö'),
                                    h('td', null, emp.department || '-'),
                                    h('td', null, emp.position || '-'),
                                    h('td', null,
                                        h('span', {
                                            className: `tag tag-${
                                                emp.grade === 'S' ? 'green' :
                                                emp.grade === 'A' ? 'blue' :
                                                emp.grade === 'B' ? 'orange' : 'red'
                                            }`
                                        }, emp.grade || 'C')
                                    ),
                                    h('td', null, Math.round(emp.overall_score || emp.ai_score || 0)),
                                    h('td', null,
                                        h('button', {
                                            className: 'btn btn-primary',
                                            onClick: () => fetchEmployeeDetail(emp.id),
                                            style: { padding: '4px 12px', fontSize: '12px' }
                                        }, 'AI Î≥¥Í≥†ÏÑú')
                                    )
                                )
                            )
                        )
                    )
                );
            };
            
            if (loading) {
                return h('div', { className: 'loading' }, 'HR ÎåÄÏãúÎ≥¥Îìú Î°úÎî© Ï§ë...');
            }
            
            return h('div', { className: 'hr-dashboard' },
                // Ìó§Îçî
                h('div', { className: 'header' },
                    h('div', null,
                        h('h1', { style: { margin: 0 } }, 'HR ÎåÄÏãúÎ≥¥Îìú'),
                        h('p', { style: { margin: '5px 0 0 0', color: '#666' } }, 
                            'AI Í∏∞Î∞ò Ïù∏Ïû¨ Î∂ÑÏÑù ÏãúÏä§ÌÖú')
                    ),
                    h('div', null,
                        h('button', { className: 'btn', onClick: fetchData }, 'üîÑ ÏÉàÎ°úÍ≥†Ïπ®'),
                        h('button', { className: 'btn btn-primary', onClick: downloadPdf }, 
                            'üìÑ PDF Îã§Ïö¥Î°úÎìú')
                    )
                ),
                
                // ÏóêÎü¨ Î©îÏãúÏßÄ
                error && h('div', { className: 'error' }, error),
                
                // ÌÉ≠ Î©îÎâ¥
                h('div', { className: 'tabs' },
                    h('button', {
                        className: `tab-button ${activeTab === 'dashboard' ? 'active' : ''}`,
                        onClick: () => setActiveTab('dashboard')
                    }, 'Í≤ΩÏòÅÏßÑ ÎåÄÏãúÎ≥¥Îìú'),
                    h('button', {
                        className: `tab-button ${activeTab === 'analysis' ? 'active' : ''}`,
                        onClick: () => setActiveTab('analysis')
                    }, 'Ï†ÑÏßÅÏõêÎ∂ÑÏÑù')
                ),
                
                // ÌÉ≠ ÏΩòÌÖêÏ∏†
                activeTab === 'dashboard' ? renderDashboard() : renderEmployeeAnalysis()
            );
        }
        
        // Ï¥àÍ∏∞Ìôî
        function initApp() {
            const checkReact = setInterval(() => {
                if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
                    clearInterval(checkReact);
                    console.log('React Î°úÎìú ÏôÑÎ£å, Ïï± ÏãúÏûë');
                    const root = ReactDOM.createRoot(document.getElementById('hr-dashboard-root'));
                    root.render(React.createElement(HRDashboard));
                }
            }, 100);
        }
        
        initApp();
    </script>
</body>
</html>