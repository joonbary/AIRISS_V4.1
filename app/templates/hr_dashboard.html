<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR ëŒ€ì‹œë³´ë“œ - AIRISS v4.0</title>
    
    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }
        
        .hr-dashboard {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03), 0 1px 6px -1px rgba(0,0,0,0.02), 0 2px 4px 0 rgba(0,0,0,0.02);
        }
        
        .ant-card-head {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .ant-card-head-title {
            color: white !important;
        }
        
        .ant-card-extra {
            color: white !important;
        }
        
        .ant-statistic-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .ant-statistic-content {
            font-size: 24px;
            font-weight: 600;
        }
        
        .ant-table-thead > tr > th {
            background: #fafafa;
            font-weight: 600;
        }
        
        .ant-progress-text {
            font-size: 12px !important;
        }
        
        .ant-tag {
            margin: 2px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        canvas {
            max-height: 300px;
        }
        
        .ant-spin-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .grade-distribution-card .ant-card-body {
            padding: 24px;
        }
        
        .risk-level-high {
            color: #ff4d4f;
            font-weight: bold;
        }
        
        .risk-level-medium {
            color: #faad14;
            font-weight: bold;
        }
        
        .promotion-score-bar {
            display: inline-block;
            width: 100px;
        }
        
        .reason-tag {
            display: inline-block;
            margin: 2px;
        }
        
        .top-talent-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .department-stats {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .header-stats {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03), 0 1px 6px -1px rgba(0,0,0,0.02), 0 2px 4px 0 rgba(0,0,0,0.02);
        }
        
        h2.ant-typography {
            color: #333;
            margin-bottom: 8px;
        }
        
        .ant-typography-secondary {
            color: #666;
        }
        
        .table-action-link {
            color: #1890ff;
            cursor: pointer;
        }
        
        .table-action-link:hover {
            color: #40a9ff;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="hr-dashboard-root"></div>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Ant Design -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- HR Dashboard Component -->
    <script>
// HR Dashboard React Component (inline to avoid path issues)
const { useState, useEffect } = React;
const { Card, Row, Col, Statistic, Table, Tag, Progress, Spin, Alert, Typography, Divider, Space, Tooltip, Button } = antd;
const { Title, Text, Paragraph } = Typography;
const { Column, ColumnGroup } = Table;
// Icon components will be created using React.createElement
// Chart.js ë“±ë¡
Chart.register(...Chart.registerables);

const HRDashboard = () => {
    const [loading, setLoading] = useState(true);
    const [data, setData] = useState(null);
    const [error, setError] = useState(null);
    const [selectedEmployee, setSelectedEmployee] = useState(null);
    const [downloadingPdf, setDownloadingPdf] = useState(false);

    useEffect(() => {
        fetchDashboardData();
    }, []);

    const fetchDashboardData = async () => {
        try {
            setLoading(true);
            const response = await fetch('/api/v1/hr-dashboard/stats');
            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            setData(result);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    const downloadPdf = async () => {
        try {
            setDownloadingPdf(true);
            const response = await fetch('/api/v1/hr-dashboard/export/pdf');
            
            if (!response.ok) {
                throw new Error('PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `HR_Dashboard_${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            antd.notification.success({
                message: 'PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ',
                description: 'HR ëŒ€ì‹œë³´ë“œ ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.',
            });
        } catch (err) {
            antd.notification.error({
                message: 'PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨',
                description: err.message,
            });
        } finally {
            setDownloadingPdf(false);
        }
    };

    const renderPromotionCandidates = () => {
        if (!data?.promotion_candidates) return null;
        
        const { count, candidates, has_candidates } = data.promotion_candidates;
        
        if (!has_candidates) {
            return (
                <Card title="ìŠ¹ì§„ í›„ë³´ì ì˜ˆì¸¡" className="dashboard-card">
                    <Alert 
                        message="í˜„ì¬ ìŠ¹ì§„ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤"
                        description="í‰ê°€ë“±ê¸‰, ê·¼ì†ì—°ìˆ˜, ì—­ëŸ‰ì ìˆ˜, ë¦¬ë”ì‹­ ë“±ì„ ì¢…í•© í‰ê°€í•œ ê²°ê³¼ í˜„ì¬ ìŠ¹ì§„ ê¸°ì¤€(70ì  ì´ìƒ)ì„ ì¶©ì¡±í•˜ëŠ” ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤."
                        type="info"
                        showIcon
                    />
                </Card>
            );
        }

        const columns = [
            {
                title: 'ì§ì›ëª…',
                dataIndex: 'name',
                key: 'name',
                render: (text, record) => (
                    <a onClick={() => setSelectedEmployee(record.uid)}>{text}</a>
                )
            },
            {
                title: 'ë¶€ì„œ',
                dataIndex: 'department',
                key: 'department'
            },
            {
                title: 'ì§ê¸‰',
                dataIndex: 'position',
                key: 'position'
            },
            {
                title: 'ìŠ¹ì§„ì ìˆ˜',
                dataIndex: 'score',
                key: 'score',
                render: score => (
                    <Progress 
                        percent={score} 
                        size="small" 
                        status={score >= 90 ? 'success' : score >= 70 ? 'normal' : 'exception'}
                    />
                )
            },
            {
                title: 'íŒë‹¨ ì‚¬ìœ ',
                dataIndex: 'reasons',
                key: 'reasons',
                width: 300,
                render: reasons => (
                    <Space direction="vertical" size="small">
                        {reasons.map((reason, idx) => (
                            <Tag key={idx} color="blue">{reason}</Tag>
                        ))}
                    </Space>
                )
            }
        ];

        return (
            <Card 
                title={`ìŠ¹ì§„ í›„ë³´ì ì˜ˆì¸¡ (${count}ëª…)`} 
                className="dashboard-card"
                extra={<Tag color="green">AI ë¶„ì„ ì™„ë£Œ</Tag>}
            >
                <Table 
                    dataSource={candidates}
                    columns={columns}
                    pagination={false}
                    size="small"
                    rowKey="uid"
                />
            </Card>
        );
    };

    const renderTopTalents = () => {
        if (!data?.top_talents) return null;
        
        const { count, employees, has_talents } = data.top_talents;

        const columns = [
            {
                title: 'ìˆœìœ„',
                key: 'rank',
                render: (_, __, index) => index + 1
            },
            {
                title: 'ì§ì›ëª…',
                dataIndex: 'name',
                key: 'name'
            },
            {
                title: 'ë¶€ì„œ',
                dataIndex: 'department',
                key: 'department'
            },
            {
                title: 'ë“±ê¸‰',
                dataIndex: 'grade',
                key: 'grade',
                render: grade => (
                    <Tag color={grade === 'S' ? 'gold' : grade === 'A' ? 'green' : 'blue'}>
                        {grade}
                    </Tag>
                )
            },
            {
                title: 'ì¢…í•©ì ìˆ˜',
                dataIndex: 'score',
                key: 'score',
                render: score => `${score}ì `
            },
            {
                title: 'íŒë‹¨ ì‚¬ìœ ',
                dataIndex: 'reasons',
                key: 'reasons',
                render: reasons => (
                    <Tooltip title={
                        <div>
                            {reasons.map((r, i) => <div key={i}>â€¢ {r}</div>)}
                        </div>
                    }>
                        <Space wrap size="small">
                            {reasons.slice(0, 2).map((reason, idx) => (
                                <Tag key={idx} color="purple">{reason}</Tag>
                            ))}
                            {reasons.length > 2 && <Tag>+{reasons.length - 2}ê°œ</Tag>}
                        </Space>
                    </Tooltip>
                )
            }
        ];

        return (
            <Card 
                title={`Top Talent (${count}ëª…)`}
                className="dashboard-card"
                extra={
                    <Space>
                        <Text type="secondary">ê¸°ì¤€: ì„±ê³¼, ì ì¬ë ¥, ì—­ëŸ‰, í˜ì‹ ì„±</Text>
                        <Tag color="purple">í•µì‹¬ì¸ì¬</Tag>
                    </Space>
                }
            >
                <Table 
                    dataSource={employees}
                    columns={columns}
                    pagination={false}
                    size="small"
                    rowKey="uid"
                />
            </Card>
        );
    };

    const renderRiskEmployees = () => {
        if (!data?.risk_employees) return null;
        
        const { count, employees, high_risk_count, medium_risk_count } = data.risk_employees;

        const columns = [
            {
                title: 'ì§ì›ëª…',
                dataIndex: 'name',
                key: 'name'
            },
            {
                title: 'ë¶€ì„œ',
                dataIndex: 'department',
                key: 'department'
            },
            {
                title: 'ìœ„í—˜ë„',
                dataIndex: 'risk_level',
                key: 'risk_level',
                render: level => (
                    <Tag color={level === 'high' ? 'red' : 'orange'}>
                        {level === 'high' ? 'ë†’ìŒ' : 'ë³´í†µ'}
                    </Tag>
                )
            },
            {
                title: 'ìœ„í—˜ì ìˆ˜',
                dataIndex: 'risk_score',
                key: 'risk_score',
                render: score => (
                    <Progress 
                        percent={score} 
                        size="small" 
                        status="exception"
                        strokeColor={score >= 70 ? '#ff4d4f' : '#faad14'}
                    />
                )
            },
            {
                title: 'ê´€ë¦¬ í•„ìš” ì‚¬ìœ ',
                dataIndex: 'reasons',
                key: 'reasons',
                width: 350,
                render: reasons => (
                    <Space wrap size="small">
                        {reasons.map((reason, idx) => (
                            <Tag key={idx} color={reason.includes('ë¶€ì§„') || reason.includes('ìœ„í—˜') ? 'red' : 'orange'}>
                                {reason}
                            </Tag>
                        ))}
                    </Space>
                )
            }
        ];

        return (
            <Card 
                title={`ê´€ë¦¬ í•„ìš” ì¸ë ¥ (ì´ ${count}ëª…)`}
                className="dashboard-card"
                extra={
                    <Space>
                        <Tag color="red">ê³ ìœ„í—˜ {high_risk_count}ëª…</Tag>
                        <Tag color="orange">ì¤‘ìœ„í—˜ {medium_risk_count}ëª…</Tag>
                    </Space>
                }
            >
                <Paragraph type="secondary">
                    ì„±ê³¼, ê·¼íƒœ, ì´ì§ìœ„í—˜ë„, ì—­ëŸ‰ ë“±ì„ ì¢…í•© í‰ê°€í•˜ì—¬ ê´€ë¦¬ê°€ í•„ìš”í•œ ì¸ë ¥ì„ ì‹ë³„í•©ë‹ˆë‹¤.
                </Paragraph>
                <Table 
                    dataSource={employees}
                    columns={columns}
                    pagination={{ pageSize: 5 }}
                    size="small"
                    rowKey="uid"
                />
            </Card>
        );
    };

    const renderGradeDistribution = () => {
        if (!data?.grade_distribution) return null;

        return (
            <Card title="í‰ê°€ ë“±ê¸‰ ë¶„í¬" className="dashboard-card">
                <div style={{ height: '300px' }}>
                    <canvas id="gradeChart"></canvas>
                </div>
                <Divider />
                <Row gutter={16}>
                    {data.grade_distribution.map(grade => (
                        <Col span={4} key={grade.grade}>
                            <Statistic
                                title={`${grade.grade}ë“±ê¸‰`}
                                value={grade.count}
                                suffix={`ëª… (${grade.percentage}%)`}
                            />
                        </Col>
                    ))}
                </Row>
            </Card>
        );
    };

    useEffect(() => {
        if (data?.grade_distribution) {
            const ctx = document.getElementById('gradeChart');
            if (ctx) {
                // ì´ì „ ì°¨íŠ¸ ì œê±°
                const existingChart = Chart.getChart(ctx);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.grade_distribution.map(g => `${g.grade}ë“±ê¸‰`),
                        datasets: [{
                            label: 'ì¸ì›ìˆ˜',
                            data: data.grade_distribution.map(g => g.count),
                            backgroundColor: [
                                'rgba(255, 215, 0, 0.8)',
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(33, 150, 243, 0.8)',
                                'rgba(255, 152, 0, 0.8)',
                                'rgba(158, 158, 158, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 215, 0, 1)',
                                'rgba(76, 175, 80, 1)',
                                'rgba(33, 150, 243, 1)',
                                'rgba(255, 152, 0, 1)',
                                'rgba(158, 158, 158, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'ë“±ê¸‰ë³„ ì¸ì› ë¶„í¬',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const grade = data.grade_distribution[context.dataIndex];
                                        return `ë¹„ìœ¨: ${grade.percentage}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ì¸ì›ìˆ˜'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'í‰ê°€ ë“±ê¸‰'
                                }
                            }
                        }
                    }
                });
            }
        }
    }, [data]);

    if (loading) {
        return (
            <div style={{ textAlign: 'center', padding: '50px' }}>
                <Spin size="large" tip="ë°ì´í„° ë¡œë”©ì¤‘..." />
            </div>
        );
    }

    if (error) {
        return (
            <Alert
                message="ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"
                description={error}
                type="error"
                showIcon
            />
        );
    }

    return (
        <div className="hr-dashboard">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <div>
                    <Title level={2}>HR ëŒ€ì‹œë³´ë“œ</Title>
                    <Paragraph>
                        AI ê¸°ë°˜ ì¸ì¬ ë¶„ì„ ë° ì˜ˆì¸¡ ì‹œìŠ¤í…œ
                    </Paragraph>
                </div>
                <Space>
                    <Button 
                        onClick={fetchDashboardData}
                        loading={loading}
                    >
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </Button>
                    <Button 
                        type="primary"
                        onClick={downloadPdf}
                        loading={downloadingPdf}
                    >
                        ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ
                    </Button>
                </Space>
            </div>
            
            <Row gutter={[16, 16]}>
                <Col span={24}>
                    <Card>
                        <Row gutter={16}>
                            <Col span={6}>
                                <Statistic 
                                    title="ì „ì²´ ì§ì›" 
                                    value={data?.total_employees || 0} 
                                    suffix="ëª…"
                                />
                            </Col>
                            <Col span={6}>
                                <Statistic 
                                    title="ìŠ¹ì§„ í›„ë³´ì" 
                                    value={data?.promotion_candidates?.count || 0} 
                                    suffix="ëª…"
                                    valueStyle={{ color: '#3f8600' }}
                                />
                            </Col>
                            <Col span={6}>
                                <Statistic 
                                    title="í•µì‹¬ ì¸ì¬" 
                                    value={data?.top_talents?.count || 0} 
                                    suffix="ëª…"
                                    valueStyle={{ color: '#722ed1' }}
                                />
                            </Col>
                            <Col span={6}>
                                <Statistic 
                                    title="ê´€ë¦¬ í•„ìš”" 
                                    value={data?.risk_employees?.count || 0} 
                                    suffix="ëª…"
                                    valueStyle={{ color: '#cf1322' }}
                                />
                            </Col>
                        </Row>
                    </Card>
                </Col>
            </Row>

            <Row gutter={[16, 16]} style={{ marginTop: '20px' }}>
                <Col span={24}>
                    {renderPromotionCandidates()}
                </Col>
            </Row>

            <Row gutter={[16, 16]} style={{ marginTop: '20px' }}>
                <Col span={24}>
                    {renderTopTalents()}
                </Col>
            </Row>

            <Row gutter={[16, 16]} style={{ marginTop: '20px' }}>
                <Col span={24}>
                    {renderRiskEmployees()}
                </Col>
            </Row>

            <Row gutter={[16, 16]} style={{ marginTop: '20px' }}>
                <Col span={24}>
                    {renderGradeDistribution()}
                </Col>
            </Row>
        </div>
    );
};

// React ë Œë”ë§
const root = ReactDOM.createRoot(document.getElementById('hr-dashboard-root'));
root.render(React.createElement(HRDashboard));
    </script>
</body>
</html>